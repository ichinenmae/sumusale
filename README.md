# 売上管理（CSVローカル集計）

Ver 3.8.2 (rev10)

# 売上管理 Webアプリ（GitHub Pages / 完全クライアントサイド）

## 使い方
- `index.html`, `app.js`, `styles.css` を同一フォルダに置き、GitHub Pagesで公開してください。
- CSVをドラッグ&ドロップ（複数同時OK、追加ドロップでマージ）。

## 集計ルール
- 結合キー: `trip_activity` の「乗車の UUID」 ↔ `payments_order` の「乗車ID」
- 配達報酬: `payments_order` で「乗車ID」がある行の「支払い額」合計
- プロモーション: `payments_order` で「乗車ID」が空欄の行の「支払い額」合計
- 除外: `payments_order` に `so.payout` を含む行（報酬支払）は除外
- 業務日付: 午前4:00で日付切替
- 週の開始: 月曜始まり

## 期間表示
- 日次/週次/月次/期間指定/全期間
- 週次は月曜に、月次は1日に自動補正

## 稼働時間（推定）
- 「配達（乗車IDあり）」の依頼時間（なければ降車/決済のフォールバック）を基準に、1時間単位で稼働判定
- 稼働時間帯の間の空きが6時間未満の場合、その空きも稼働扱い
- 推定: 稼働時間、時給（総売上/稼働時間）、配達/時（配達回数/稼働時間）

## チャート
- 積み上げステップ（累積）
- ズーム: ホイール/ピンチ
- パン: Shift+ドラッグ
- 省略表示: 非稼働時間（1時間）を詰めた仮想X軸で表示


## 100円単位の四捨五入
- 「読み込み時に100円単位で四捨五入」をONにすると、payments_orderの支払い額を読み込み時に100円単位へ丸めます。
- 既に読み込んだデータには反映されないため、ONにした後にデータをクリアして再読み込みしてください。


## 日次（4:00始まり）
- 日次表示では、業務日付の1日を「04:00〜翌03:59」としてチャートのX軸を固定します。
- 日次（省略OFF）の場合、同一チャート上に「累積ステップ」と「1時間別の報酬・件数バー」を同時表示します。


## 日次表示モード
- 日次（省略OFF）の場合、「階段（累積）のみ」「時間帯別（1時間）」「同時表示」を選べます。
- いずれもX軸は業務日付の 04:00〜翌04:00 に固定します。

## パン操作
- 「パン有効」ON時
  - **ドラッグ**で横方向にパン
  - PCでは **ホイール/トラックパッドのスクロールで横パン**もできます
    - ズーム有効OFF: そのままスクロールでパン
    - ズーム有効ON: **Shift+スクロール** または 横スクロール（トラックパッド）でパン

##

## テーマ
- 画面右上のテーマ選択で「ダーク / スムレコ風」を切り替えできます。


## 郵便番号辞書（日本郵便 KEN_ALL）
- `assets/utf_ken_all.csv` を同梱しています。
- C列(7桁郵便番号) → H列(市区町村) / I列(町域) の漢字表記を参照し、降車場所の短縮表記に利用します（ランキング・詳細データ）。


## ローカルで確認する場合
- `http://`（ローカルサーバ）で開くのが推奨です。
- `file://` で開くと `assets/utf_ken_all.csv` の自動読込が失敗することがあります。その場合は画面の「郵便番号辞書 > 辞書を読み込む」からCSVを選択してください。


## 表示期間カレンダーの稼働日マーク
- 表示期間（開始日/終了日）のカレンダーで、配達が1件以上あった業務日付に●（ドット）を表示します。
- 判定は trips（kind=base）由来の降車時間を業務日付(4:00切替)に変換したものです。


## ズーム/パン
- ズーム（ホイール/ピンチ）とパン（Shift+ホイール等）は chartjs-plugin-zoom を使用。
- ON/OFFはグラフ描画後でも反映されます。


## グラフのズーム/スクロール（ボタン方式）
- ＋/－：表示範囲を拡大/縮小（中心固定）
- ◀/▶：表示範囲を左右に移動
- リセット：表示期間の範囲に戻す


## rev63
- ズーム/パンのチェックボックスを廃止し、グラフ直下のボタン（＋/－/◀/▶/リセット）で操作します。


## rev63
- JSON書き出しボタンをデバッグ用途として目立たないデザインに変更（ラベル追記）。


## rev63
- 「集計結果JSONを書き出し」(btnExport) をデバッグ用途として目立たないデザインに変更（ラベルを変更、btn-subtle を付与）。


## rev63
- 「時間帯別にプロモを含める」の隣のリセットボタン（btnResetZoom）を削除（リセットはグラフ下のボタンに統一）。


## rev63
- テーマ切替（ライト/ダーク）を廃止し、ライト固定に変更（テーマ選択UI削除、JS側の切替処理削除）。


## rev63
- 画面上部のグラデーション背景を完全廃止（CSS変数 --headerBg 含む）。単色（#f4f5f7）。


## rev63
- 「ファイル選択」ボタンを他ボタンと同一デザイン（btn btn--secondary）に統一（filePicker inputは不可視化）。


## rev63
- ドロップエリアの「対応: trip_activity/payments_order（例...）」表記を集計ルール欄に移動。


## rev63
- ドロップエリアの「対応: trip_activity/payments_order」「例: ...」表記を削除し、集計ルール（details内）へ移動。


## rev63
- ドロップエリア中央に「ここにCSVをドラッグ＆ドロップ」を配置し、やや目立つ色で表示。


## rev63
- ドロップエリア中央の文言が二重表示されていたため、ドロップエリア内を再構成（大:ドラッグ&ドロップ / 中:ファイル選択 / 小:マージ説明 を中央揃え）。


## rev63
- 誤って詳細データ付近に表示されていた「ファイル種別の判定」メモを削除。


## rev63
- ヘッダー表記を「ス ム セ ル」に変更。
- フッター表記を「@ichinenmae / Ver ...」形式に変更。


## rev63
- ヘッダー「ス ム セ ル」のフォントを Dela Gothic One に変更し、サイズを拡大。


## rev63
- ヘッダー「ス ム セ ル」をさらに拡大（約2倍、clamp(56px, 8vw, 96px)）。


## rev63
- フルHD表示で詳細データ領域が崩れる対策: containerのmax-widthを1600pxに拡大、grid子要素のmin-widthを0に設定、detailLayoutを1カラムに変更。
- ヘッダー見出しのサイズ指定がappNameを上書きしていたため、appNameには適用しないよう修正。


## rev63
- ヘッダー見出しが `.header__title h1{font-size:20px;}` に上書きされていたため、appNameには適用しないよう修正。
- 「ス ム セ ル」のサイズを下の説明文の約2倍になるよう調整（clamp(24px, 3.5vw, 34px)）。


## rev63
- ヘッダー上部/見出し周りの余白を縮小（header padding・container padding・見出し/説明文のマージン）。


## rev63
- HTMLの<title>を「スムセル （smooth sales） 売上管理」に変更。
