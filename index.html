<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>売上管理（CSVローカル集計）</title>
  <link rel="stylesheet" href="styles.css" />
  <!-- CSV parser -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/date-fns@2.30.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>
</head>
<body>
  <header class="header">
    <div class="header__title">
      <h1>売上管理</h1>
      <p class="muted">CSVはブラウザ内でのみ処理され、外部へ送信しません。</p>
    </div>
    <div class="header__actions">
      <button id="btnClear" class="btn btn--secondary" type="button">データをクリア</button>
      <button id="btnExport" class="btn btn--secondary" type="button">集計結果JSONを書き出し</button>
    </div>
  </header>

  <main class="container">
    <section class="card dropzone" id="dropzone" aria-label="CSV読み込み">
      <div class="dropzone__inner">
        <div class="dropzone__title">ここにCSVをドラッグ＆ドロップ</div>
        <div class="dropzone__desc">
          <div>対応: <code>trip_activity</code> / <code>payments_order</code>（複数同時OK / 追加ドロップでマージ）</div>
          <div class="muted">例: <code>...-trip_activity-....csv</code>, <code>...-payments_order-....csv</code></div>
        </div>
        <input id="filePicker" type="file" accept=".csv,text/csv" multiple />
      </div>
      <div class="dropzone__status" id="loadStatus">
        未読み込み
      </div>
    </section>

    <section class="grid">
      <section class="card">
        <div class="card__header">
          <h2>表示期間</h2>
          <div class="filters">
            <button class="pill is-active" data-range="day">1日</button>
            <button class="pill" data-range="thisWeek">今週（月曜始まり）</button>
            <button class="pill" data-range="last7">直近7日間</button>
            <button class="pill" data-range="thisMonth">今月</button>
            <button class="pill" data-range="all">全期間</button>
          </div>
        </div>

        <div class="toggles">
          <label class="toggle">
            <input id="togglePromo" type="checkbox" checked />
            <span>プロモーションを表示</span>
          </label>
          <label class="toggle">
            <input id="toggleFailed" type="checkbox" />
            <span>failed/キャンセル等も含める（trip側）</span>
          </label>
        </div>

        <div class="stats" id="stats">
          <div class="stat">
            <div class="stat__label">配達報酬</div>
            <div class="stat__value" id="statBase">-</div>
          </div>
          <div class="stat">
            <div class="stat__label">プロモーション</div>
            <div class="stat__value" id="statPromo">-</div>
          </div>
          <div class="stat">
            <div class="stat__label">総売上</div>
            <div class="stat__value" id="statTotal">-</div>
          </div>
          <div class="stat">
            <div class="stat__label">回数（乗車IDあり）</div>
            <div class="stat__value" id="statTrips">-</div>
          </div>
        </div>

        <div class="chartWrap">
          <canvas id="chart" height="140"></canvas>
        </div>

        <details class="help">
          <summary>集計ルール（4時切替など）</summary>
          <ul>
            <li>結合キー: <b>trip_activityの乗車UUID</b> と <b>payments_orderの乗車ID</b></li>
            <li>配達報酬: payments_orderで「乗車ID」がある行の <b>支払い額</b> 合計</li>
            <li>プロモーション: payments_orderで「乗車ID」が空欄の行の <b>支払い額</b> 合計</li>
            <li>備考が <b>so.payout</b> の行は報酬支払のため集計対象外</li>
            <li>業務日付: <b>午前4:00</b> で日付切替（例: 02/13 01:00 → 02/12扱い）</li>
            <li>週の開始: <b>月曜日</b></li>
          </ul>
        </details>
      </section>

      <section class="card">
        <div class="card__header">
          <h2>詳細データ</h2>
          <div class="muted small">表示件数が多い場合、先頭から一定件数のみ表示します。</div>
        </div>

        <div class="tableTools">
          <input id="searchBox" class="search" type="search" placeholder="検索（住所 / ID / 備考など）" />
          <select id="sortSelect" class="select">
            <option value="timeDesc">時間: 新しい順</option>
            <option value="timeAsc">時間: 古い順</option>
            <option value="amountDesc">金額: 大きい順</option>
            <option value="amountAsc">金額: 小さい順</option>
          </select>
        </div>

        <div class="tableWrap">
          <table class="table" id="detailTable">
            <thead>
              <tr>
                <th>日時</th>
                <th>業務日付</th>
                <th>区分</th>
                <th class="num">金額</th>
                <th>乗車ID</th>
                <th>取引ID</th>
                <th>場所（降車/住所）</th>
                <th>備考</th>
              </tr>
            </thead>
            <tbody id="detailTbody"></tbody>
          </table>
        </div>
        <div class="muted small" id="detailNote"></div>
      </section>
    </section>
  </main>

  <footer class="footer muted small">
    GitHub Pages向け / 完全クライアントサイド（サーバー処理なし）
  </footer>

  <script src="app.js"></script>
</body>
</html>
